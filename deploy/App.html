<!DOCTYPE html>
<html>
<head>
    <title>investmentcategory</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",getSettingsFields:function(){return[{name:"onlyshowaccepted",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Only show accepted work items."}]},config:{defaultSettings:{onlyshowaccepted:!0}},noFeatureId:3,noInvestmentCategory:"Unplanned Stories",noInvestmentColor:"#666",cvFeatureId:1,cvInvestmentCategory:"CV Defects",cvInvestmentColor:"#FF8200",defectFeatureId:2,defectInvestmentCategory:"non-CV Defects",defectInvestmentColor:"#F6A900",colors:["#B81B10","#FAD200","#F66349","#FFDD82"],chartColors:[],features:[],workItems:[],totalPoint:0,onScopeChange:function(scope){this.callParent(arguments),this.start(scope)},start:function(scope){this.down("rallychart")&&this.down("rallychart").destroy(),this.down("label")&&this.down("label").destroy(),this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading..."}),this._myMask.show();var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["UserStory","Defect"],fetch:["ObjectID","PlanEstimate","Feature","Tags"],filters:[{property:"Release.Name",value:scope.record.data.Name}],context:dataScope,limit:1/0},this),onlyShowAccepted=this.getSetting("onlyshowaccepted");if(onlyShowAccepted){var acceptedFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:">=",value:"Accepted"});store.addFilter(acceptedFilter,!1)}this.features={},this.features[this.cvFeatureId]={},this.features[this.cvFeatureId].estimate=0,this.features[this.cvFeatureId].investmentCategory=this.cvInvestmentCategory,this.chartColors.push(this.cvInvestmentColor),this.features[this.defectFeatureId]={},this.features[this.defectFeatureId].estimate=0,this.features[this.defectFeatureId].investmentCategory=this.defectInvestmentCategory,this.chartColors.push(this.defectInvestmentColor),this.features[this.noFeatureId]={},this.features[this.noFeatureId].estimate=0,this.features[this.noFeatureId].investmentCategory=this.noInvestmentCategory,this.chartColors.push(this.noInvestmentColor),this.workItems=[],this.totalPoints=0,store.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(records.length>0?(_.each(records,function(record){var featureId=this.noFeatureId;record.raw.Tags&&_.find(record.raw.Tags._tagsNameArray,function(tag){return"Customer Voice"==tag.Name})?featureId=this.cvFeatureId:record.raw.Feature?featureId=record.raw.Feature.ObjectID:"defect"==record.get("_type")&&(featureId=this.defectFeatureId),featureId in this.features||(this.features[featureId]={},this.features[featureId].estimate=0,this.features[featureId].investmentCategory=this.noInvestmentCategory),this.features[featureId].estimate+=record.raw.PlanEstimate,this.totalPoints+=record.raw.PlanEstimate},this),this._myMask.msg="Loading Features...",this.loadFeatures(0)):0===records.length&&0===this.features.length&&this.showNoDataBox())}})},loadFeatures:function(featureIndex){var keys=Object.keys(this.features);if(featureIndex>=keys.length)this.compileData();else if(keys[featureIndex]==this.noFeatureId||keys[featureIndex]==this.defectFeatureId||keys[featureIndex]==this.cvFeatureId)this.loadFeatures(featureIndex+1);else{this.features[keys[featureIndex]].investmentCategory="Unknown";var dataScope={workspace:this.getContext().getWorkspaceRef(),project:null},store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature"],fetch:["ObjectID","InvestmentCategory"],filters:[{property:"ObjectID",value:keys[featureIndex]}],context:dataScope,limit:1/0},this);store.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&records.length>0&&_.each(records,function(record){var featureId=record.raw.ObjectID;this.features[featureId].investmentCategory=record.raw.InvestmentCategory},this),this.loadFeatures(featureIndex+1)}})}},compileData:function(){this._myMask.msg="Compiling Data...";var investmentSums={};_.each(this.features,function(feature){if(!(feature.investmentCategory in investmentSums)){investmentSums[feature.investmentCategory]=0;var keysLength=Object.keys(investmentSums).length;keysLength>3&&this.chartColors.push(this.colors[(keysLength-4)%this.colors.length])}investmentSums[feature.investmentCategory]+=feature.estimate},this);var series=[];series.push({}),series[0].name="Investment Categories",series[0].colorByPoint=!0,series[0].data=[],_.each(_.keys(investmentSums),function(investmentCategory){series[0].data.push({name:investmentCategory,y:investmentSums[investmentCategory]/this.totalPoints})},this),this.makeChart(series)},makeChart:function(series){var chart=this.add({xtype:"rallychart",chartConfig:{chart:{type:"pie"},title:{text:"Investment Category Spend"},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %"}}}},chartData:{series:series}});chart.setChartColors(this.chartColors),this._myMask.hide()},showNoDataBox:function(){this._myMask.hide(),this.add({xtype:"label",text:"There is no data. Check if there are work items assigned for the Release."})}});

            Rally.launchApp('CustomApp', {
                name:"investmentcategory",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
